import tkinter as tk
from tkinter import * 
from tkinter import messagebox
import os
import requests
from bs4 import BeautifulSoup
from langchain_compressa import CompressaEmbeddings, ChatCompressa
from langchain_core.documents import Document
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_core.prompts import ChatPromptTemplate
from langchain.chains import create_retrieval_chain
from langchain.vectorstores import FAISS
from langchain.chains.combine_documents import create_stuff_documents_chain
os.environ["TOKENIZERS_PARALLELISM"] = "false"
os.environ["KMP_DUPLICATE_LIB_OK"] = "TRUE"
urls = [
    "https://ftbwiki.org/Mystical_Flower",
    "https://ftbwiki.org/Glimmering_Flowers",
    "https://ftbwiki.org/Mystical_White_Flower",
    "https://ftbwiki.org/Mystical_Magenta_Flower",
    "https://ftbwiki.org/Mystical_Light_Blue_Flower",
    "https://ftbwiki.org/Mystical_Yellow_Flower",
    "https://ftbwiki.org/Mystical_Lime_Flower",
    "https://ftbwiki.org/Mystical_Pink_Flower",
    "https://ftbwiki.org/Mystical_Orange_Flower",
    "https://ftbwiki.org/Mystical_Light_Gray_Flower",
    "https://ftbwiki.org/Mystical_Gray_Flower",
    "https://ftbwiki.org/Mystical_Cyan_Flower",
    "https://ftbwiki.org/Mystical_Purple_Flower",
    "https://ftbwiki.org/Mystical_Blue_Flower",
    "https://ftbwiki.org/Mystical_Brown_Flower",
    "https://ftbwiki.org/Mystical_Green_Flower",
    "https://ftbwiki.org/Mystical_Red_Flower",
    "https://ftbwiki.org/Mystical_Black_Flower",
    "https://ftbwiki.org/Shimmering_Mushroom",
    "https://ftbwiki.org/Tall_Mystical_Flower",
    "https://ftbwiki.org/Black_Lotus_(Botania)",
    "https://ftbwiki.org/Blacker_Lotus",
    "https://ftbwiki.org/Dandelifeon",
    "https://ftbwiki.org/Cellular_Block",
    "https://ftbwiki.org/Daybloom",
    "https://ftbwiki.org/Daybloom_Primus",
    "https://ftbwiki.org/Endoflame",
    "https://ftbwiki.org/Entropinnyum",
    "https://ftbwiki.org/Gourmaryllis",
    "https://ftbwiki.org/Hydroangeas",
    "https://ftbwiki.org/Kekimurus",
    "https://ftbwiki.org/Munchdew",
    "https://ftbwiki.org/Narslimmus",
    "https://ftbwiki.org/Nightshade",
    "https://ftbwiki.org/Nightshade_Primus",
    "https://ftbwiki.org/Rosa_Arcana",
    "https://ftbwiki.org/Shulk_Me_Not",
    "https://ftbwiki.org/Spectrolus",
    "https://ftbwiki.org/Thermalily",
    "https://ftbwiki.org/Agricarnation",
    "https://ftbwiki.org/Bellethorne",
    "https://ftbwiki.org/Bergamute",
    "https://ftbwiki.org/Bubbell",
    "https://ftbwiki.org/Clayconia",
    "https://ftbwiki.org/Daffomill",
    "https://ftbwiki.org/Dreadthorne",
    "https://ftbwiki.org/Exoflame",
    "https://ftbwiki.org/Fallen_Kanade",
    "https://ftbwiki.org/Heisei_Dream",
    "https://ftbwiki.org/Hopperhock",
    "https://ftbwiki.org/Hyacidus",
    "https://ftbwiki.org/Jaded_Amaranthus",
    "https://ftbwiki.org/Jiyuulia",
    "https://ftbwiki.org/Loonium",
    "https://ftbwiki.org/Marimorphosis",
    "https://ftbwiki.org/Medumone",
    "https://ftbwiki.org/Orechid",
    "https://ftbwiki.org/Pollidisiac",
    "https://ftbwiki.org/Rannuncarpus",
    "https://ftbwiki.org/Solegnolia",
    "https://ftbwiki.org/Spectranthemum",
    "https://ftbwiki.org/Tangleberrie",
    "https://ftbwiki.org/Tigerseye",
    "https://ftbwiki.org/Vinculotus",
    "https://ftbwiki.org/Manastar",
    "https://ftbwiki.org/Pure_Daisy"
    "https://ftbwiki.org/Mystical_White_Petal",
    "https://ftbwiki.org/Mystical_Magenta_Petal",
    "https://ftbwiki.org/Mystical_Light_Blue_Petal",
    "https://ftbwiki.org/Mystical_Yellow_Petal",
    "https://ftbwiki.org/Mystical_Lime_Petal",
    "https://ftbwiki.org/Mystical_Pink_Petal",
    "https://ftbwiki.org/Mystical_Orange_Petal",
    "https://ftbwiki.org/Mystical_Light_Gray_Petal",
    "https://ftbwiki.org/Mystical_Gray_Petal",
    "https://ftbwiki.org/Mystical_Cyan_Petal",
    "https://ftbwiki.org/Mystical_Purple_Petal",
    "https://ftbwiki.org/Mystical_Blue_Petal",
    "https://ftbwiki.org/Mystical_Brown_Petal",
    "https://ftbwiki.org/Mystical_Green_Petal",
    "https://ftbwiki.org/Mystical_Red_Petal",
    "https://ftbwiki.org/Mystical_Black_Petal",
    "https://ftbwiki.org/Pasture_Seeds",
    "https://ftbwiki.org/Boreal_Seeds",
    "https://ftbwiki.org/Dry_Pasture_Seeds",
    "https://ftbwiki.org/Golden_Pasture_Seeds",
    "https://ftbwiki.org/Vivid_Pasture_Seeds",
    "https://ftbwiki.org/Scorched_Pasture_Seeds",
    "https://ftbwiki.org/Infused_Pasture_Seeds",
    "https://ftbwiki.org/Mutated_Pasture_Seeds",
    "https://ftbwiki.org/Force_Relay",
    "https://ftbwiki.org/Open_Crate",
    "https://ftbwiki.org/Drum_of_the_Wild",
    "https://ftbwiki.org/Drum_of_the_Gathering",
    "https://ftbwiki.org/Livingwood_Avatar",
    "https://ftbwiki.org/Mana_Pool",
    "https://ftbwiki.org/Diluted_Mana_Pool",
    "https://ftbwiki.org/Fabulous_Mana_Pool",
    "https://ftbwiki.org/The_Everlasting_Guilty_Pool",
    "https://ftbwiki.org/Mana_Spreader",
    "https://ftbwiki.org/Pulse_Mana_Spreader",
    "https://ftbwiki.org/Elven_Mana_Spreader",
    "https://ftbwiki.org/Gaia_Mana_Spreader",
    "https://ftbwiki.org/Mana_Lens",
    "https://ftbwiki.org/Mana_Lens:_Bore",
    "https://ftbwiki.org/Mana_Lens:_Bounce",
    "https://ftbwiki.org/Mana_Lens:_Celebratory",
    "https://ftbwiki.org/Mana_Lens:_Damaging",
    "https://ftbwiki.org/Mana_Lens:_Efficiency",
    "https://ftbwiki.org/Mana_Lens:_Entropic",
    "https://ftbwiki.org/Mana_Lens:_Flare",
    "https://ftbwiki.org/Mana_Lens:_Flash",
    "https://ftbwiki.org/Mana_Lens:_Force",
    "https://ftbwiki.org/Mana_Lens:_Gravity",
    "https://ftbwiki.org/Mana_Lens:_Kindle",
    "https://ftbwiki.org/Mana_Lens:_Influence",
    "https://ftbwiki.org/Mana_Lens:_Magnetizing",
    "https://ftbwiki.org/Mana_Lens:_Messenger",
    "https://ftbwiki.org/Mana_Lens:_Paintslinger",
    "https://ftbwiki.org/Mana_Lens:_Phantom",
    "https://ftbwiki.org/Mana_Lens:_Potency",
    "https://ftbwiki.org/Mana_Lens:_Redirective",
    "https://ftbwiki.org/Mana_Lens:_Resistance",
    "https://ftbwiki.org/Mana_Lens:_Tripwire",
    "https://ftbwiki.org/Mana_Lens:_Velocity",
    "https://ftbwiki.org/Mana_Lens:_Warp",
    "https://ftbwiki.org/Mana_Lens:_Weight",
    "https://ftbwiki.org/Mana_Detector",
    "https://ftbwiki.org/Mana_Distributor",
    "https://ftbwiki.org/Mana_Fluxfield",
    "https://ftbwiki.org/Mana_Prism",
    "https://ftbwiki.org/Mana_Void",
    "https://ftbwiki.org/Mana_Pump",
    "https://ftbwiki.org/Minecart_with_Mana_Pool",
    "https://ftbwiki.org/Spreader_Turntable",
    "https://ftbwiki.org/Teru_Teru_Bozu",
    "https://ftbwiki.org/Ender_Overseer",
    "https://ftbwiki.org/Eye_of_the_Ancients",
    "https://ftbwiki.org/Hovering_Hourglass",
    "https://ftbwiki.org/Red_String",
    "https://ftbwiki.org/Alchemy_Catalyst",
    "https://ftbwiki.org/Conjuration_Catalyst",
    "https://ftbwiki.org/Mana_Pylon",
    "https://ftbwiki.org/Natura_Pylon",
    "https://ftbwiki.org/Gaia_Pylon",
    "https://ftbwiki.org/Petal_Apothecary",
    "https://ftbwiki.org/Forest_Petal_Apothecary",
    "https://ftbwiki.org/Plains_Petal_Apothecary",
    "https://ftbwiki.org/Mountain_Petal_Apothecary",
    "https://ftbwiki.org/Fungal_Petal_Apothecary",
    "https://ftbwiki.org/Swamp_Petal_Apothecary",
    "https://ftbwiki.org/Desert_Petal_Apothecary",
    "https://ftbwiki.org/Taiga_Petal_Apothecary",
    "https://ftbwiki.org/Mesa_Petal_Apothecary",
    "https://ftbwiki.org/Botanical_Brewery",
    "https://ftbwiki.org/Elven_Gateway_Core",
    "https://ftbwiki.org/Fel_Pumpkin",
    "https://ftbwiki.org/Mana_Enchanter",
    "https://ftbwiki.org/Runic_Altar",
    "https://ftbwiki.org/Terrestrial_Agglomeration_Plate",
    "https://ftbwiki.org/Spark",
    "https://ftbwiki.org/Spark_Augment:_Dispersive",
    "https://ftbwiki.org/Spark_Augment:_Dominant",
    "https://ftbwiki.org/Spark_Augment:_Recessive",
    "https://ftbwiki.org/Spark_Augment:_Isolated",
    "https://ftbwiki.org/Spark_Tinkerer",
    "https://ftbwiki.org/Corporea_Spark",
    "https://ftbwiki.org/Master_Corporea_Spark",
    "https://ftbwiki.org/Abstruse_Platform",
    "https://ftbwiki.org/Infrangible_Platform",
    "https://ftbwiki.org/Spectral_Platform",
    "https://ftbwiki.org/Cocoon_of_Caprice",
    "https://ftbwiki.org/Enchanted_Soil",
    "https://ftbwiki.org/Incense_Plate",
    "https://ftbwiki.org/Life_Imbuer",
    "https://ftbwiki.org/Manatide_Bellows",
    "https://ftbwiki.org/Spectral_Rail",
    "https://ftbwiki.org/Bifrost_Block",
    "https://ftbwiki.org/Livingrock",
    "https://ftbwiki.org/Livingrock_Brick",
    "https://ftbwiki.org/Mossy_Livingrock_Brick",
    "https://ftbwiki.org/Cracked_Livingrock_Brick",
    "https://ftbwiki.org/Chiseled_Livingrock_Brick",
    "https://ftbwiki.org/Livingwood",
    "https://ftbwiki.org/Livingwood_Planks",
    "https://ftbwiki.org/Mossy_Livingwood_Planks",
    "https://ftbwiki.org/Framed_Livingwood",
    "https://ftbwiki.org/Pattern_Framed_Livingwood",
    "https://ftbwiki.org/Glimmering_Livingwood",
    "https://ftbwiki.org/Dreamwood",
    "https://ftbwiki.org/Dreamwood_Planks",
    "https://ftbwiki.org/Mossy_Dreamwood_Planks",
    "https://ftbwiki.org/Framed_Dreamwood",
    "https://ftbwiki.org/Pattern_Framed_Dreamwood",
    "https://ftbwiki.org/Glimmering_Dreamwood",
    "https://ftbwiki.org/Block_of_Elven_Quartz",
    "https://ftbwiki.org/Block_of_Smokey_Quartz_(Botania)",
    "https://ftbwiki.org/Block_of_Redquartz",
    "https://ftbwiki.org/Block_of_Mana_Quartz",
    "https://ftbwiki.org/Block_of_Blaze_Quartz",
    "https://ftbwiki.org/Block_of_Lavender_Quartz",
    "https://ftbwiki.org/Block_of_Sunny_Quartz",
    "https://ftbwiki.org/Blaze_Lamp",
    "https://ftbwiki.org/Block_of_Dragonstone",
    "https://ftbwiki.org/Block_of_Elementium",
    "https://ftbwiki.org/Block_of_Mana_Diamond",
    "https://ftbwiki.org/Block_of_Manasteel",
    "https://ftbwiki.org/Block_of_Terrasteel",
    "https://ftbwiki.org/Reed_Block",
    "https://ftbwiki.org/Thatch_(Botania)",
    "https://ftbwiki.org/Alfglass",
    "https://ftbwiki.org/Hellish_Brick",
    "https://ftbwiki.org/Managlass",
    "https://ftbwiki.org/Shimmerrock",
    "https://ftbwiki.org/Shimmerwood_Planks",
    "https://ftbwiki.org/Soul_Brick",
    "https://ftbwiki.org/Frosty_Brick",
    "https://ftbwiki.org/Roof_Tile",
    "https://ftbwiki.org/Dry_Grass",
    "https://ftbwiki.org/Golden_Grass",
    "https://ftbwiki.org/Vivid_Grass",
    "https://ftbwiki.org/Scorched_Grass",
    "https://ftbwiki.org/Infused_Grass",
    "https://ftbwiki.org/Mutated_Grass",
    "https://ftbwiki.org/White_Portuguese_Pavement",
    "https://ftbwiki.org/Black_Portuguese_Pavement",
    "https://ftbwiki.org/Blue_Portuguese_Pavement",
    "https://ftbwiki.org/Red_Portuguese_Pavement",
    "https://ftbwiki.org/Yellow_Portuguese_Pavement",
    "https://ftbwiki.org/Green_Portuguese_Pavement",
    "https://ftbwiki.org/End_Stone_Bricks_(Botania)",
    "https://ftbwiki.org/Chiseled_End_Stone_Brick",
    "https://ftbwiki.org/Ender_Bricks_(Botania)",
    "https://ftbwiki.org/Pillar_Ender_Bricks",
    "https://ftbwiki.org/Prismarine_(Botania)",
    "https://ftbwiki.org/Dark_Prismarine_(Botania)",
    "https://ftbwiki.org/Prismarine_Bricks_(Botania)",
    "https://ftbwiki.org/Sea_Lantern_(Botania)",
    "https://ftbwiki.org/Starfield_Creator",
    "https://ftbwiki.org/Tiny_Potato",
    "https://ftbwiki.org/Floral_Powder",
    "https://ftbwiki.org/Flower_Petal",
    "https://ftbwiki.org/Incense_Stick",
    "https://ftbwiki.org/Redstone_Root",
    "https://ftbwiki.org/Livingwood_Twig",
    "https://ftbwiki.org/Pestle_and_Mortar",
    "https://ftbwiki.org/Managlass_Vial",
    "https://ftbwiki.org/Manasteel_Ingot",
    "https://ftbwiki.org/Manasteel_Nugget_(Botania)",
    "https://ftbwiki.org/Mana_Diamond",
    "https://ftbwiki.org/Mana_Infused_String",
    "https://ftbwiki.org/Mana_Pearl",
    "https://ftbwiki.org/Mana_Powder",
    "https://ftbwiki.org/Manaweave_Cloth",
    "https://ftbwiki.org/Prismarine_Shard_(Botania)",
    "https://ftbwiki.org/Tainted_Blood_Pendant",
    "https://ftbwiki.org/Alfglass_Flask",
    "https://ftbwiki.org/Dragonstone",
    "https://ftbwiki.org/Dreamwood_Twig",
    "https://ftbwiki.org/Elementium_Ingot",
    "https://ftbwiki.org/Elementium_Nugget",
    "https://ftbwiki.org/Pixie_Dust_(Botania)",
    "https://ftbwiki.org/Red_String",
    "https://ftbwiki.org/Ender_Air_Bottle",
    "https://ftbwiki.org/Gaia_Spirit",
    "https://ftbwiki.org/Terrasteel_Ingot",
    "https://ftbwiki.org/Terrasteel_Nugget",
    "https://ftbwiki.org/Rune_of_Air",
    "https://ftbwiki.org/Rune_of_Earth",
    "https://ftbwiki.org/Rune_of_Water",
    "https://ftbwiki.org/Rune_of_Fire",
    "https://ftbwiki.org/Rune_of_Mana",
    "https://ftbwiki.org/Rune_of_Autumn",
    "https://ftbwiki.org/Rune_of_Spring",
    "https://ftbwiki.org/Rune_of_Summer",
    "https://ftbwiki.org/Rune_of_Winter",
    "https://ftbwiki.org/Rune_of_Envy",
    "https://ftbwiki.org/Rune_of_Gluttony",
    "https://ftbwiki.org/Rune_of_Greed",
    "https://ftbwiki.org/Rune_of_Lust",
    "https://ftbwiki.org/Rune_of_Pride",
    "https://ftbwiki.org/Rune_of_Sloth",
    "https://ftbwiki.org/Rune_of_Wrath",
    "https://ftbwiki.org/Elven_Quartz",
    "https://ftbwiki.org/Smokey_Quartz_(Botania)",
    "https://ftbwiki.org/Redquartz",
    "https://ftbwiki.org/Mana_Quartz",
    "https://ftbwiki.org/Blaze_Quartz",
    "https://ftbwiki.org/Lavender_Quartz",
    "https://ftbwiki.org/Sunny_Quartz" 
]
def ftbwiki(url):
    # Отправляем GET-запрос к указанному URL
    response = requests.get(url)

    # Создаем объект BeautifulSoup для парсинга HTML-контента
    soup = BeautifulSoup(response.content, 'html.parser')

    # Находим основной контейнер с содержимым статьи
    content = soup.find(id="wikipage").find(class_="clearfix")

    text = []
    # Итерируемся по всем элементам 'p', 'h2' и 'h3' в основном контенте

    for element in content.find_all(['p', 'h2', 'h3']):
        if element.name == 'p':
            # Если это параграф, добавляем его текст как есть
            text.append(element.text)
        elif element.name in ['h2', 'h3']:
            # Если это заголовок, форматируем его с ## и добавляем перенос строки
            text.append(f"\n## {element.text.strip()}\n")

    # Объединяем все элементы текста в одну строку, разделяя их переносами строк
    return '\n'.join(text)

document = [Document(page_content=ftbwiki(url)) for url in urls]

#Проверим, что все загрузилось корректно
print (document)
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=600, chunk_overlap=200, add_start_index=True
)
chunks = text_splitter.split_documents(document)

print(f"Всего создано чанков: {len(chunks)}")
print(f"Пример чанка:\n{chunks[0].page_content[:1000]}...")
from langchain.llms import Ollama
from langchain.embeddings import GPT4AllEmbeddings
from langchain.vectorstores import Chroma
from langchain.chains import RetrievalQA
from langchain_ollama import OllamaLLM
import chromadb
window = tk.Tk()
window.title("AI helper for minecraft with mods")
window.geometry("1500x750")
frame1 = tk.Frame(master=window, height=750,width=1500, bg="black")
frame1.pack(fill=tk.BOTH, side=tk.LEFT, expand=True)
label1 = tk.Label(master=frame1, text="Ask your questions here", bg="black", fg = "white",font=('Kontanter Bold',20,'bold'))
label1.place(x=600,y=150)
entry = tk.Entry(width=50, bg="grey", fg="white",font=('Kontanter Bold',12,'bold'))
entry.insert(0, "")
entry.place(x=550,y=200)
def rag():
    question = entry.get()
    OLLAMA_DEBUG=1
    ollama = Ollama(base_url ='http://localhost:11434', model = 'llama3:8b')
    chromadb.api.client.SharedSystemClient.clear_system_cache()
    vectorstore=Chroma.from_documents(documents=chunks,embedding=GPT4AllEmbeddings())
    qachain = RetrievalQA.from_chain_type(ollama, retriever=vectorstore.as_retriever())
    label2 = tk.Label(master=frame1, text=(qachain({"query":question})), bg="black", fg = "white",font=('Kontanter Bold',10,'bold'),wrap =1250)
    label2.place(x=100,y=250)
btn_decrease = tk.Button(master=window, text="Ask",fg="white",bg="grey",font=('Kontanter Bold',12,'bold'),command=rag)
btn_decrease.place(x=960,y=195) 
window.mainloop()
